# Bilibili è§†é¢‘æ’ä»¶ - äº‹ä»¶ç³»ç»Ÿ

## ä¸»è¦ç”¨é€”å’ŒåŠŸèƒ½æ¦‚è¿°

`internal.event`åŒ…æ˜¯Bilibiliè§†é¢‘æ’ä»¶çš„äº‹ä»¶ç®¡ç†æ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£ç»Ÿä¸€ç®¡ç†å’Œè§¦å‘æ’ä»¶çš„è‡ªå®šä¹‰äº‹ä»¶ã€‚è¯¥æ¨¡å—ä¸ºå…¶ä»–æ’ä»¶æä¾›å®Œæ•´çš„äº‹ä»¶ç›‘å¬æ¥å£ï¼Œå°è£…äº†äº‹ä»¶çš„åˆ›å»ºå’Œè°ƒç”¨é€»è¾‘ï¼Œç¡®ä¿äº‹ä»¶å‚æ•°çš„æ­£ç¡®ä¼ é€’ã€‚

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- ğŸ” **ç”¨æˆ·ç™»å½•/ç™»å‡ºäº‹ä»¶ç®¡ç†** - å¤„ç†Bilibiliè´¦æˆ·ç™»å½•å’Œç™»å‡ºçŠ¶æ€å˜åŒ–
- ğŸ“¹ **è§†é¢‘ä¸‰è¿çŠ¶æ€æ£€æŸ¥äº‹ä»¶** - ç›‘æ§ç”¨æˆ·å¯¹è§†é¢‘çš„ç‚¹èµã€æŠ•å¸ã€æ”¶è—æ“ä½œ
- ğŸ‘¥ **UPä¸»å…³æ³¨çŠ¶æ€æ£€æŸ¥äº‹ä»¶** - è·Ÿè¸ªç”¨æˆ·å¯¹UPä¸»çš„å…³æ³¨çŠ¶æ€å˜åŒ–
- ğŸ¯ **ç»Ÿä¸€äº‹ä»¶è§¦å‘æœºåˆ¶** - æä¾›ç»Ÿä¸€çš„äº‹ä»¶è°ƒç”¨æ¥å£

## é‡è¦çš„ç±»å’Œæ¥å£

### 1. EventManager (äº‹ä»¶ç®¡ç†å™¨)

`EventManager`æ˜¯ä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼ˆobjectï¼‰ï¼Œä½œä¸ºæ•´ä¸ªäº‹ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒè°ƒåº¦å™¨ï¼Œè´Ÿè´£ç»Ÿä¸€ç®¡ç†å’Œè§¦å‘æ‰€æœ‰è‡ªå®šä¹‰äº‹ä»¶ã€‚

### 2. äº‹ä»¶ç±»å‹

#### BilibiliLoginEvent (ç™»å½•äº‹ä»¶)
- å½“ç©å®¶æˆåŠŸç™»å½•Bilibiliè´¦æˆ·æ—¶è§¦å‘
- ç»§æ‰¿è‡ª`BukkitProxyEvent`

#### BilibiliLogoutEvent (ç™»å‡ºäº‹ä»¶)
- å½“ç©å®¶é€€å‡ºç™»å½•Bilibiliè´¦æˆ·æ—¶è§¦å‘
- æä¾›ä¼šè¯æŒç»­æ—¶é—´è®¡ç®—åŠŸèƒ½

#### VideoTripleStatusCheckEvent (è§†é¢‘ä¸‰è¿æ£€æŸ¥äº‹ä»¶)
- æ£€æŸ¥ç©å®¶å¯¹è§†é¢‘çš„ä¸‰è¿çŠ¶æ€ï¼ˆç‚¹èµã€æŠ•å¸ã€æ”¶è—ï¼‰æ—¶è§¦å‘
- æ”¯æŒè¯¦ç»†çš„ä¸‰è¿çŠ¶æ€æŸ¥è¯¢

#### UpFollowStatusCheckEvent (UPä¸»å…³æ³¨æ£€æŸ¥äº‹ä»¶)
- æ£€æŸ¥ç©å®¶å¯¹UPä¸»å…³æ³¨çŠ¶æ€æ—¶è§¦å‘
- æä¾›å…³æ³¨å…³ç³»çš„è¯¦ç»†ä¿¡æ¯

## ä¸»è¦æ–¹æ³•å’ŒåŠŸèƒ½ç‚¹

### EventManager æ ¸å¿ƒæ–¹æ³•

#### 1. `callVideoTripleStatusCheckEvent(player: Player, tripleData: VideoTripleData)`
- **åŠŸèƒ½ï¼š** è§¦å‘è§†é¢‘ä¸‰è¿çŠ¶æ€æ£€æŸ¥äº‹ä»¶
- **å‚æ•°ï¼š**
  - `player` - æ‰§è¡Œæ£€æŸ¥çš„ç©å®¶
  - `tripleData` - è§†é¢‘ä¸‰è¿æ•°æ®
- **ä½¿ç”¨åœºæ™¯ï¼š** å½“ç©å®¶æ£€æŸ¥è§†é¢‘ä¸‰è¿çŠ¶æ€æ—¶è°ƒç”¨

#### 2. `callUpFollowStatusCheckEvent(player: Player, followData: UpFollowData)`
- **åŠŸèƒ½ï¼š** è§¦å‘UPä¸»å…³æ³¨çŠ¶æ€æ£€æŸ¥äº‹ä»¶
- **å‚æ•°ï¼š**
  - `player` - æ‰§è¡Œæ£€æŸ¥çš„ç©å®¶
  - `followData` - UPä¸»å…³æ³¨æ•°æ®
- **ä½¿ç”¨åœºæ™¯ï¼š** å½“ç©å®¶æ£€æŸ¥UPä¸»å…³æ³¨çŠ¶æ€æ—¶è°ƒç”¨

#### 3. `callBilibiliLoginEvent(player: Player, session: LoginSession)`
- **åŠŸèƒ½ï¼š** è§¦å‘Bilibiliç™»å½•äº‹ä»¶
- **å‚æ•°ï¼š**
  - `player` - ç™»å½•çš„ç©å®¶
  - `session` - ç™»å½•ä¼šè¯ä¿¡æ¯
- **ä½¿ç”¨åœºæ™¯ï¼š** å½“ç©å®¶æˆåŠŸç™»å½•Bilibiliè´¦æˆ·æ—¶è°ƒç”¨

#### 4. `callBilibiliLogoutEvent(player: Player, previousSession: LoginSession)`
- **åŠŸèƒ½ï¼š** è§¦å‘Bilibiliç™»å‡ºäº‹ä»¶
- **å‚æ•°ï¼š**
  - `player` - ç™»å‡ºçš„ç©å®¶
  - `previousSession` - ä¹‹å‰çš„ç™»å½•ä¼šè¯ä¿¡æ¯
- **ä½¿ç”¨åœºæ™¯ï¼š** å½“ç©å®¶é€€å‡ºç™»å½•Bilibiliè´¦æˆ·æ—¶è°ƒç”¨

### äº‹ä»¶ç±»åŠŸèƒ½ç‰¹æ€§

#### VideoTripleStatusCheckEvent åŠŸèƒ½æ–¹æ³•
- `hasTripleAction()` - æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ä¸‰è¿æ“ä½œ
- `getBvid()` - è·å–è§†é¢‘BVå·
- `getMid()` - è·å–ç”¨æˆ·MID
- `isLiked()` - æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
- `getCoinCount()` - è·å–æŠ•å¸æ•°é‡ï¼ˆ0-2ï¼‰
- `isFavorited()` - æ£€æŸ¥æ˜¯å¦å·²æ”¶è—

#### BilibiliLoginEvent/LogoutEvent åŠŸèƒ½æ–¹æ³•
- `getMid()` - è·å–ç”¨æˆ·MID
- `getNickname()` - è·å–ç”¨æˆ·æ˜µç§°
- `getLoginTime()` - è·å–ç™»å½•æ—¶é—´ï¼ˆä»…ç™»å½•äº‹ä»¶ï¼‰
- `getSessionDuration()` - è·å–ä¼šè¯æŒç»­æ—¶é—´ï¼ˆä»…ç™»å‡ºäº‹ä»¶ï¼‰

#### UpFollowStatusCheckEvent åŠŸèƒ½æ–¹æ³•
- `getUpMid()` - è·å–UPä¸»MID
- `getUpName()` - è·å–UPä¸»åç§°
- `getFollowerMid()` - è·å–å…³æ³¨è€…MID
- `isFollowing()` - æ£€æŸ¥æ˜¯å¦å·²å…³æ³¨

## ä½¿ç”¨ç¤ºä¾‹æˆ–è¯´æ˜

### 1. è§¦å‘ç™»å½•äº‹ä»¶
```kotlin
// åœ¨ç”¨æˆ·æˆåŠŸç™»å½•åè°ƒç”¨
EventManager.callBilibiliLoginEvent(player, loginSession)
```

### 2. ç›‘å¬è§†é¢‘ä¸‰è¿äº‹ä»¶
```kotlin
@SubscribeEvent
fun onVideoTripleCheck(event: VideoTripleStatusCheckEvent) {
    val player = event.player
    val bvid = event.getBvid()

    if (event.hasTripleAction()) {
        // ç”¨æˆ·å·²è¿›è¡Œä¸‰è¿æ“ä½œï¼Œå¯ä»¥å‘æ”¾å¥–åŠ±
        if (event.isLiked() && event.getCoinCount() > 0 && event.isFavorited()) {
            // å®Œæ•´ä¸‰è¿ï¼Œç»™äºˆç‰¹æ®Šå¥–åŠ±
            player.sendMessage("Â§aæ­å–œï¼æ‚¨å·²å®Œæˆå®Œæ•´ä¸‰è¿æ“ä½œï¼")
        }
    }
}
```

### 3. ç›‘å¬UPä¸»å…³æ³¨äº‹ä»¶
```kotlin
@SubscribeEvent
fun onUpFollowCheck(event: UpFollowStatusCheckEvent) {
    if (event.isFollowing()) {
        val upName = event.getUpName()
        event.player.sendMessage("Â§aæ‚¨å·²å…³æ³¨UPä¸»: $upName")
        // å¯ä»¥åœ¨è¿™é‡Œå‘æ”¾å…³æ³¨å¥–åŠ±
    }
}
```

### 4. ç›‘å¬ç™»å‡ºäº‹ä»¶å¹¶è®¡ç®—ä¼šè¯æ—¶é•¿
```kotlin
@SubscribeEvent
fun onBilibiliLogout(event: BilibiliLogoutEvent) {
    val sessionDuration = event.getSessionDuration()
    val minutes = sessionDuration / (1000 * 60)

    event.player.sendMessage("Â§eæ‚¨æœ¬æ¬¡ç™»å½•æ—¶é•¿: ${minutes}åˆ†é’Ÿ")
}
```

## æ¶æ„è®¾è®¡ç‰¹ç‚¹

1. **è§£è€¦è®¾è®¡ï¼š** äº‹ä»¶ç³»ç»Ÿä¸å…·ä½“ä¸šåŠ¡é€»è¾‘åˆ†ç¦»ï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§
2. **æ‰©å±•æ€§ï¼š** åŸºäºBukkitäº‹ä»¶ç³»ç»Ÿï¼Œæ”¯æŒå…¶ä»–æ’ä»¶ç›‘å¬
3. **ç±»å‹å®‰å…¨ï¼š** ä½¿ç”¨å¼ºç±»å‹çš„äº‹ä»¶ç±»ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯
4. **ç»Ÿä¸€ç®¡ç†ï¼š** é€šè¿‡EventManagerç»Ÿä¸€ç®¡ç†æ‰€æœ‰äº‹ä»¶çš„è§¦å‘
5. **ä¸°å¯Œä¿¡æ¯ï¼š** äº‹ä»¶æºå¸¦å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¾¿äºç›‘å¬è€…å¤„ç†

è¯¥äº‹ä»¶ç³»ç»Ÿä¸ºBilibiliè§†é¢‘æ’ä»¶æä¾›äº†å®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œæ”¯æŒæ’ä»¶é—´çš„æ¾è€¦åˆé€šä¿¡ï¼Œæ˜¯æ’ä»¶æ‰©å±•å’Œç¬¬ä¸‰æ–¹é›†æˆçš„é‡è¦åŸºç¡€è®¾æ–½ã€‚