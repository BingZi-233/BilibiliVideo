name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: 8
  GRADLE_VERSION: '8.14.3'
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.workers.max=2

jobs:
  build:
    name: ğŸ”¨ æ„å»º
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_version: ${{ steps.version.outputs.short_version }}
      should_release: ${{ steps.check_release.outputs.should_release }}

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• é…ç½® JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ“¦ ç¼“å­˜ Gradle ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/kotlin-dsl
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ˜ é…ç½® Gradle æ„å»ºå·¥å…·
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}
          cache-read-only: false

      - name: ğŸ·ï¸ è§£æç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          # ä» gradle.properties è¯»å–ç‰ˆæœ¬
          BASE_VERSION=$(grep '^version=' gradle.properties | cut -d'=' -f2 | tr -d ' ')
          
          # æ·»åŠ æ„å»ºä¿¡æ¯
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SHORT_VERSION="${BASE_VERSION}-${SHORT_HASH}"
          else
            SHORT_VERSION="${BASE_VERSION}-${SHORT_HASH}"
          fi
          VERSION="v${SHORT_VERSION}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short_version=${SHORT_VERSION}" >> $GITHUB_OUTPUT
          echo "base_version=${BASE_VERSION}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ å®Œæ•´ç‰ˆæœ¬: ${VERSION}"
          echo "ğŸ·ï¸ ç‰ˆæœ¬å·: ${SHORT_VERSION}"

      - name: ğŸ¯ åˆ¤æ–­å‘å¸ƒæ¡ä»¶
        id: check_release
        run: |
          SHOULD_RELEASE="false"
          
          # ä»…masteråˆ†æ”¯æ¨é€æ—¶å‘å¸ƒ
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && [[ "${{ github.event_name }}" == "push" ]]; then
            SHOULD_RELEASE="true"
            echo "âœ… masteråˆ†æ”¯æ¨é€ï¼Œå°†åˆ›å»ºæ­£å¼å‘å¸ƒ"
          else
            echo "â„¹ï¸ ä¸æ»¡è¶³å‘å¸ƒæ¡ä»¶ï¼Œä»…æ‰§è¡Œæ„å»ºå’Œæµ‹è¯•"
          fi
          
          echo "should_release=${SHOULD_RELEASE}" >> $GITHUB_OUTPUT

      - name: ğŸ“ æ›´æ–°ç‰ˆæœ¬å·åˆ° gradle.properties
        run: |
          echo "ğŸ”„ æ›´æ–° gradle.properties ä¸­çš„ç‰ˆæœ¬å·ä¸º: ${{ steps.version.outputs.short_version }}"
          sed -i "s/^version=.*/version=${{ steps.version.outputs.short_version }}/" gradle.properties
          cat gradle.properties

      - name: ğŸ”§ æ‰§è¡Œé¡¹ç›®æ„å»º
        run: |
          chmod +x gradlew
          ./gradlew clean build --no-daemon --info

      - name: ğŸ› ï¸ æ„å»ºå¼€å‘ç‰ˆæœ¬API
        run: ./gradlew taboolibBuildApi -PDeleteCode --no-daemon --info

      - name: ğŸ“¦ ä¿å­˜ç”¨æˆ·ç‰ˆæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ github.sha }}
          path: |
            build/libs/*.jar
            !build/libs/*-sources.jar
            !build/libs/*-javadoc.jar
            !build/libs/*-api.jar
          retention-days: 30

      - name: ğŸ“¦ ä¿å­˜APIç‰ˆæ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: api-artifacts-${{ github.sha }}
          path: |
            build/libs/*-api.jar
          retention-days: 30

  maven-publish:
    name: ğŸ“š å‘å¸ƒåˆ° Maven ä»“åº“
    needs: build
    if: |
      github.ref == 'refs/heads/master' &&
      github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    environment: MavenConfig

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: â˜• é…ç½® JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ğŸ“¦ ç¼“å­˜ Gradle ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/kotlin-dsl
          key: ${{ runner.os }}-gradle-maven-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-maven-
            ${{ runner.os }}-gradle-

      - name: ğŸ˜ é…ç½® Gradle æ„å»ºå·¥å…·
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: ${{ env.GRADLE_VERSION }}
          cache-read-only: true

      - name: ğŸš€ æ¨é€åˆ° Maven ä»“åº“
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        run: |
          # æ›´æ–° gradle.properties ç‰ˆæœ¬å·ä»¥ä¿æŒä¸€è‡´æ€§
          echo "ğŸ”„ æ›´æ–° gradle.properties ä¸­çš„ç‰ˆæœ¬å·ä¸º: ${{ needs.build.outputs.short_version }}"
          sed -i "s/^version=.*/version=${{ needs.build.outputs.short_version }}/" gradle.properties
          chmod +x gradlew
          # å…ˆæ„å»ºAPI JARï¼Œå†å‘å¸ƒ
          ./gradlew taboolibBuildApi -PDeleteCode --no-daemon --info
          ./gradlew publish --no-daemon --info

      - name: âœ… Maven å‘å¸ƒç»“æœ
        if: success()
        run: |
          echo "âœ… Maven å‘å¸ƒæˆåŠŸå®Œæˆ"
          echo "ğŸ“¦ å‘å¸ƒç‰ˆæœ¬: ${{ needs.build.outputs.version }}"
          echo "ğŸ”— Maven ä»“åº“åœ°å€: https://repo.aeoliancloud.com/repository/releases/"
          echo "ğŸ“š Maven åæ ‡: online.bingzi:bilibilivideo:${{ needs.build.outputs.short_version }}"
          echo "ğŸ’¡ ä½¿ç”¨æ–¹å¼: åœ¨ pom.xml æˆ– build.gradle ä¸­æ·»åŠ ä»¥ä¸Šåæ ‡"


  release:
    name: ğŸ‰ åˆ›å»º GitHub Release
    needs: build
    if: needs.build.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ è·å–ç”¨æˆ·ç‰ˆæ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ github.sha }}
          path: build/libs/

      - name: ğŸ“ ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          # è·å–æœ€æ–°çš„æ ‡ç­¾
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          echo "## ğŸ“ æ›´æ–°å†…å®¹" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [ -n "$LATEST_TAG" ]; then
            echo "### è‡ª ${LATEST_TAG} ä»¥æ¥çš„å˜æ›´ï¼š" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          
            # æŒ‰ç±»å‹åˆ†ç»„æäº¤è®°å½•
            echo "#### âœ¨ æ–°åŠŸèƒ½" >> CHANGELOG.md
            FEAT_COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^feat" 2>/dev/null || echo "")
            echo "${FEAT_COMMITS:-  - æš‚æ— æ–°åŠŸèƒ½}" >> CHANGELOG.md
            echo -e "\n" >> CHANGELOG.md
          
            echo "#### ğŸ› ä¿®å¤" >> CHANGELOG.md
            FIX_COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^fix" 2>/dev/null || echo "")
            echo "${FIX_COMMITS:-  - æš‚æ— ä¿®å¤}" >> CHANGELOG.md
            echo -e "\n" >> CHANGELOG.md
          
            echo "#### ğŸ“š æ–‡æ¡£" >> CHANGELOG.md
            DOCS_COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --grep="^docs" 2>/dev/null || echo "")
            echo "${DOCS_COMMITS:-  - æš‚æ— æ–‡æ¡£æ›´æ–°}" >> CHANGELOG.md
            echo -e "\n" >> CHANGELOG.md
          
            echo "#### ğŸ”§ å…¶ä»–å˜æ›´" >> CHANGELOG.md
            git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --grep -v "^feat\|^fix\|^docs" | head -20 >> CHANGELOG.md
            echo -e "\n" >> CHANGELOG.md
          else
            echo "### æ‰€æœ‰å˜æ›´ï¼š" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" | head -50 >> CHANGELOG.md
            echo -e "\n" >> CHANGELOG.md
          fi
          
          echo "### ğŸ“Š ç»Ÿè®¡" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          if [ -n "$LATEST_TAG" ]; then
            COMMITS=$(git rev-list ${LATEST_TAG}..HEAD --count)
            FILES_CHANGED=$(git diff --stat ${LATEST_TAG}..HEAD | tail -1)
          else
            COMMITS=$(git rev-list HEAD --count)
            FILES_CHANGED=$(git diff --stat $(git rev-list --max-parents=0 HEAD)..HEAD | tail -1)
          fi
          echo "- ğŸ“Š æäº¤æ¬¡æ•°: ${COMMITS}" >> CHANGELOG.md
          echo "- ğŸ“‚ ${FILES_CHANGED}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # è´¡çŒ®è€…
          echo "### ğŸ‘¥ è´¡çŒ®è€…" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          if [ -n "$LATEST_TAG" ]; then
            git log ${LATEST_TAG}..HEAD --pretty=format:"%an" | sort -u | sed 's/^/- @/' >> CHANGELOG.md
          else
            git log --pretty=format:"%an" | sort -u | sed 's/^/- @/' | head -10 >> CHANGELOG.md
          fi
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ å‘å¸ƒæ–°ç‰ˆæœ¬
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.version }}
          name: BilibiliVideo ${{ needs.build.outputs.version }}
          body: |
            <div align="center">
            
            ![TabooLib](https://img.shields.io/badge/TabooLib-6.2.3+-green)
            ![Minecraft](https://img.shields.io/badge/Minecraft-1.8--1.21+-orange)
            ![Java](https://img.shields.io/badge/Java-8+-red)
            ![Build Status](https://img.shields.io/github/actions/workflow/status/BingZi-233/BilibiliVideo/build.yml)
            ![Downloads](https://img.shields.io/github/downloads/BingZi-233/BilibiliVideo/total)
            
            </div>
            
            ---
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            
            ## ğŸš€ å¿«é€Ÿå¼€å§‹
            
            ### å®‰è£…æ­¥éª¤
            
            1. **ä¸‹è½½æ’ä»¶**
               ```
               BilibiliVideo-${{ needs.build.outputs.short_version }}.jar
               ```
            
            2. **æ”¾ç½®æ–‡ä»¶**
               å°† JAR æ–‡ä»¶æ”¾å…¥æœåŠ¡å™¨çš„ `plugins` ç›®å½•
            
            3. **é‡å¯æœåŠ¡å™¨**
               ```bash
               /reload æˆ–é‡å¯æœåŠ¡å™¨
               ```
            
            4. **é…ç½®è¿æ¥**
               ```bash
               /bilibili preset list         # æŸ¥çœ‹å¯ç”¨é¢„è®¾
               /bilibili preset apply        # åº”ç”¨é¢„è®¾é…ç½®
               /bilibili connect             # è¿æ¥åˆ° Bilibili æœåŠ¡å™¨
               /bilibili status              # æŸ¥çœ‹è¿æ¥çŠ¶æ€
               ```
            
            ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            
            - **Java**: 8 æˆ–æ›´é«˜ç‰ˆæœ¬
            - **æœåŠ¡å™¨**: Bukkit/Spigot/Paper 1.8-1.21+
            - **å†…å­˜**: å»ºè®®è‡³å°‘ 2GB
            - **Bilibili API**: æ”¯æŒ Bilibili Open API
            
            ## ğŸ”— ç›¸å…³é“¾æ¥
            
            | èµ„æº | é“¾æ¥ |
            |------|------|
            | ğŸ“š æ–‡æ¡£ | [Wiki](https://github.com/BingZi-233/BilibiliVideo/wiki) |
            | ğŸ› é—®é¢˜åé¦ˆ | [Issues](https://github.com/BingZi-233/BilibiliVideo/issues) |
            | ğŸ’¬ è®¨è®ºäº¤æµ | [Discussions](https://github.com/BingZi-233/BilibiliVideo/discussions) |
            | ğŸ“– é…ç½®æŒ‡å— | [é…ç½®æ–‡æ¡£](https://github.com/BingZi-233/BilibiliVideo/wiki/Configuration) |
            | ğŸ¯ è·¯çº¿å›¾ | [Roadmap](https://github.com/BingZi-233/BilibiliVideo/projects) |
            
            ## âš ï¸ é‡è¦æç¤º
            
            - é¦–æ¬¡ä½¿ç”¨è¯·ä»”ç»†é˜…è¯» [é…ç½®æŒ‡å—](https://github.com/BingZi-233/BilibiliVideo/wiki/Configuration)
            - é‡åˆ°é—®é¢˜è¯·å…ˆæŸ¥çœ‹ [FAQ](https://github.com/BingZi-233/BilibiliVideo/wiki/FAQ)
            - å‡çº§å‰è¯·å¤‡ä»½é…ç½®æ–‡ä»¶
            
            ## ğŸ’– æ”¯æŒé¡¹ç›®
            
            å¦‚æœè¿™ä¸ªæ’ä»¶å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·è€ƒè™‘ï¼š
            - â­ ç»™é¡¹ç›®ç‚¹ä¸ª Star
            - ğŸ› æŠ¥å‘Šé—®é¢˜å’Œå»ºè®®
            - ğŸ¤ è´¡çŒ®ä»£ç 
            - ğŸ“¢ å‘æœ‹å‹æ¨è
            
            ---
            
            <div align="center">
            
            **æ„Ÿè°¢ä½¿ç”¨ BilibiliVideoï¼** ğŸ®
            
                  [æŠ¥å‘Šé—®é¢˜](https://github.com/BingZi-233/BilibiliVideo/issues/new/choose) | [è¯·æ±‚åŠŸèƒ½](https://github.com/BingZi-233/BilibiliVideo/issues/new?labels=enhancement) | [åŠ å…¥è®¨è®º](https://github.com/BingZi-233/BilibiliVideo/discussions)
            
            </div>
          draft: false
          files: |
            build/libs/*.jar
            !build/libs/*-sources.jar
            !build/libs/*-javadoc.jar
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… å‘å¸ƒå®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ GitHub Release å‘å¸ƒæˆåŠŸ"
          echo "ğŸ“¦ å‘å¸ƒç‰ˆæœ¬: ${{ needs.build.outputs.version }}"
          echo "ğŸ”— Release é¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ needs.build.outputs.version }}"
          echo "ğŸ“¥ ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/download/${{ needs.build.outputs.version }}/BilibiliVideo-${{ needs.build.outputs.short_version }}.jar"